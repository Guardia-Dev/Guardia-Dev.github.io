<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        Â© Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            å·§ç”¨ç¬¦å·è¡¨ - æ¢æ±‚ fishhook åŸç†ï¼ˆä¸€ï¼‰ | 
        
        Guardia Â· ç“œåœ°
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",C,fishhook">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "å¾®è½¯é›…é»‘", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Guardia Â· ç“œåœ°">
    <meta name="msapplication-starturl" content="http://m.desgard.com/2017/12/17/fishook-1/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Guardia Â· ç“œåœ°">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://m.desgard.com/2017/12/17/fishook-1/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="å·§ç”¨ç¬¦å·è¡¨ - æ¢æ±‚ fishhook åŸç†ï¼ˆä¸€ï¼‰ | Guardia Â· ç“œåœ°">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="C"> <meta property="og:article:tag" content="fishhook"> 

    
        <meta property="article:published_time" content="Sun Dec 17 2017 00:00:00 GMT+0800">
        <meta property="article:modified_time" content="Mon Dec 18 2017 09:26:11 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://m.desgard.com/2017/12/17/fishook-1/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://m.desgard.com/2017/12/17/fishook-1/index.html",
    "headline": "å·§ç”¨ç¬¦å·è¡¨ - æ¢æ±‚ fishhook åŸç†ï¼ˆä¸€ï¼‰",
    "datePublished": "Sun Dec 17 2017 00:00:00 GMT+0800",
    "dateModified": "Mon Dec 18 2017 09:26:11 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Desgard_Duan",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "I write many code to write less code. ğŸ’»"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Guardia Â· ç“œåœ°",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",C,fishhook",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
        <script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?c5a8123bc51782a3083a631ed9ff50e4';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>
    
    

    <!-- Custom Head -->
    

<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å…³äºç¬¦å·è¡¨çš„åŸºæœ¬çŸ¥è¯†"><span class="post-toc-number">1.</span> <span class="post-toc-text"><a href="#&#x5173;&#x4E8E;&#x7B26;&#x53F7;&#x8868;&#x7684;&#x57FA;&#x672C;&#x77E5;&#x8BC6;" class="headerlink" title="&#x5173;&#x4E8E;&#x7B26;&#x53F7;&#x8868;&#x7684;&#x57FA;&#x672C;&#x77E5;&#x8BC6;"></a>&#x5173;&#x4E8E;&#x7B26;&#x53F7;&#x8868;&#x7684;&#x57FA;&#x672C;&#x77E5;&#x8BC6;</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Lazy-Binding-è¿‡ç¨‹"><span class="post-toc-number">1.1.</span> <span class="post-toc-text"><a href="#Lazy-Binding-&#x8FC7;&#x7A0B;" class="headerlink" title="Lazy Binding &#x8FC7;&#x7A0B;"></a>Lazy Binding &#x8FC7;&#x7A0B;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Dynamic-Symbol-Table"><span class="post-toc-number">1.2.</span> <span class="post-toc-text"><a href="#Dynamic-Symbol-Table" class="headerlink" title="Dynamic Symbol Table"></a>Dynamic Symbol Table</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ç†è§£-fishhook"><span class="post-toc-number">2.</span> <span class="post-toc-text"><a href="#&#x7406;&#x89E3;-fishhook" class="headerlink" title="&#x7406;&#x89E3; fishhook"></a>&#x7406;&#x89E3; fishhook</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#æ˜ç¡®æ€è·¯"><span class="post-toc-number">2.1.</span> <span class="post-toc-text"><a href="#&#x660E;&#x786E;&#x601D;&#x8DEF;" class="headerlink" title="&#x660E;&#x786E;&#x601D;&#x8DEF;"></a>&#x660E;&#x786E;&#x601D;&#x8DEF;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å‡†å¤‡"><span class="post-toc-number">2.2.</span> <span class="post-toc-text"><a href="#&#x51C6;&#x5907;" class="headerlink" title="&#x51C6;&#x5907;"></a>&#x51C6;&#x5907;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#è°ƒè¯•ä»£ç "><span class="post-toc-number">2.3.</span> <span class="post-toc-text"><a href="#&#x8C03;&#x8BD5;&#x4EE3;&#x7801;" class="headerlink" title="&#x8C03;&#x8BD5;&#x4EE3;&#x7801;"></a>&#x8C03;&#x8BD5;&#x4EE3;&#x7801;</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#dyld-register-func-for-add-image-æ˜¯ä»€ä¹ˆï¼Ÿ"><span class="post-toc-number">2.3.1.</span> <span class="post-toc-text"><a href="#dyld-register-func-for-add-image-&#x662F;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="_dyld_register_func_for_add_image &#x662F;&#x4EC0;&#x4E48;&#xFF1F;"></a><code>_dyld_register_func_for_add_image</code> &#x662F;&#x4EC0;&#x4E48;&#xFF1F;</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ä¸ºä»€ä¹ˆä¼ å…¥çš„-rebind-symbols-for-image-ä½œä¸ºå›è°ƒå‡½æ•°å‘¢ï¼Ÿ"><span class="post-toc-number">2.3.2.</span> <span class="post-toc-text"><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x4F20;&#x5165;&#x7684;-rebind-symbols-for-image-&#x4F5C;&#x4E3A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5462;&#xFF1F;" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48;&#x4F20;&#x5165;&#x7684; _rebind_symbols_for_image &#x4F5C;&#x4E3A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5462;&#xFF1F;"></a>&#x4E3A;&#x4EC0;&#x4E48;&#x4F20;&#x5165;&#x7684; <code>_rebind_symbols_for_image</code> &#x4F5C;&#x4E3A;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5462;&#xFF1F;</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#intptr-t-æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ"><span class="post-toc-number">2.3.3.</span> <span class="post-toc-text"><a href="#intptr-t-&#x662F;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#xFF1F;" class="headerlink" title="intptr_t &#x662F;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#xFF1F;"></a><code>intptr_t</code> &#x662F;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#xFF1F;</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é‡ç»‘å®šå¯»å€-åŸºå€å‡†å¤‡è¿‡ç¨‹"><span class="post-toc-number">2.4.</span> <span class="post-toc-text"><a href="#&#x91CD;&#x7ED1;&#x5B9A;&#x5BFB;&#x5740;-&#x57FA;&#x5740;&#x51C6;&#x5907;&#x8FC7;&#x7A0B;" class="headerlink" title="&#x91CD;&#x7ED1;&#x5B9A;&#x5BFB;&#x5740; - &#x57FA;&#x5740;&#x51C6;&#x5907;&#x8FC7;&#x7A0B;"></a>&#x91CD;&#x7ED1;&#x5B9A;&#x5BFB;&#x5740; - &#x57FA;&#x5740;&#x51C6;&#x5907;&#x8FC7;&#x7A0B;</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-è·å–-Linkedit-Base-Addr"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text"><a href="#1-&#x83B7;&#x53D6;-Linkedit-Base-Addr" class="headerlink" title="1. &#x83B7;&#x53D6; Linkedit Base Addr"></a>1. &#x83B7;&#x53D6; Linkedit Base Addr</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-äºŒæ¬¡éå†-Load-Command-çš„ç›®çš„"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text"><a href="#2-&#x4E8C;&#x6B21;&#x904D;&#x5386;-Load-Command-&#x7684;&#x76EE;&#x7684;" class="headerlink" title="2. &#x4E8C;&#x6B21;&#x904D;&#x5386; Load Command &#x7684;&#x76EE;&#x7684;"></a>2. &#x4E8C;&#x6B21;&#x904D;&#x5386; Load Command &#x7684;&#x76EE;&#x7684;</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#é‡ç»‘å®š"><span class="post-toc-number">2.5.</span> <span class="post-toc-text"><a href="#&#x91CD;&#x7ED1;&#x5B9A;" class="headerlink" title="&#x91CD;&#x7ED1;&#x5B9A;"></a>&#x91CD;&#x7ED1;&#x5B9A;</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å°ç»“"><span class="post-toc-number">3.</span> <span class="post-toc-text"><a href="#&#x5C0F;&#x7ED3;" class="headerlink" title="&#x5C0F;&#x7ED3;"></a>&#x5C0F;&#x7ED3;</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#å¼•æ–‡"><span class="post-toc-number">4.</span> <span class="post-toc-text"><a href="#&#x5F15;&#x6587;" class="headerlink" title="&#x5F15;&#x6587;"></a>&#x5F15;&#x6587;</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#é¸£è°¢"><span class="post-toc-number">5.</span> <span class="post-toc-text"><a href="#&#x9E23;&#x8C22;" class="headerlink" title="&#x9E23;&#x8C22;"></a>&#x9E23;&#x8C22;</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                å·§ç”¨ç¬¦å·è¡¨ - æ¢æ±‚ fishhook åŸç†ï¼ˆä¸€ï¼‰
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Desgard_Duan</strong>
        <span>12æœˆ 17, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/C/">C</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/fishhook/">fishhook</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=å·§ç”¨ç¬¦å·è¡¨ - æ¢æ±‚ fishhook åŸç†ï¼ˆä¸€ï¼‰&url=http://m.desgard.com/2017/12/17/fishook-1/index.html&pic=http://m.desgard.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                åˆ†äº«åˆ°å¾®åš
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=å·§ç”¨ç¬¦å·è¡¨ - æ¢æ±‚ fishhook åŸç†ï¼ˆä¸€ï¼‰&url=http://m.desgard.com/2017/12/17/fishook-1/index.html&via=Desgard_Duan" target="_blank">
            <li class="mdl-menu__item">
                åˆ†äº«åˆ° Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    

    <!-- Share Google+ -->
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>è¿™æ˜¯ <em>æ¢æ±‚ fishhook åŸç†</em> ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ã€‚ä¸»è¦è®²è¿°äº† Facebook å¼€æºåº“ <a href="">fishhook</a> çš„æºç å®ç°ç»†èŠ‚ã€‚éœ€è¦å…·å¤‡ Mach-O ç›¸å…³çŸ¥è¯†ã€‚å¯ä»¥å…ˆé˜…è¯» <em><a href="https://xiaozhuanlan.com/topic/6750382941" target="_blank" rel="noopener">Mach-O æ–‡ä»¶æ ¼å¼æ¢ç´¢</a></em> ä¸€æ–‡ã€‚</p>
<h2 id="å…³äºç¬¦å·è¡¨çš„åŸºæœ¬çŸ¥è¯†"><a href="#å…³äºç¬¦å·è¡¨çš„åŸºæœ¬çŸ¥è¯†" class="headerlink" title="å…³äºç¬¦å·è¡¨çš„åŸºæœ¬çŸ¥è¯†"></a>å…³äºç¬¦å·è¡¨çš„åŸºæœ¬çŸ¥è¯†</h2><h3 id="Lazy-Binding-è¿‡ç¨‹"><a href="#Lazy-Binding-è¿‡ç¨‹" class="headerlink" title="Lazy Binding è¿‡ç¨‹"></a>Lazy Binding è¿‡ç¨‹</h3><p>åœ¨ä¹‹å‰çš„<a href="https://xiaozhuanlan.com/topic/6750382941" target="_blank" rel="noopener">Mach-O æ–‡ä»¶æ ¼å¼æ¢ç´¢</a>ä¸€æ–‡ä¸­æåŠåˆ°äº† <code>__DATA.__la_symbol_ptr</code> å’Œ <code>__DATA.__nl_symbol_ptr</code> è¿™ä¸¤ä¸ªæŒ‡é’ˆè¡¨ï¼Œåˆ†åˆ«ä¸º<strong>lazy bindingæŒ‡é’ˆè¡¨</strong>å’Œ<strong>non lazy bindingæŒ‡é’ˆè¡¨</strong>ã€‚å¹¶ä¸”è¿™ä¸¤ä¸ªæŒ‡é’ˆè¡¨ï¼Œä¿å­˜ç€ä¸å­—ç¬¦ä¸²æ ‡å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆã€‚</p>
<p>è€Œ Mach-O æ–‡ä»¶æ–‡ä»¶ä¸­é€šè¿‡ dyld åŠ è½½çš„ Lazy Binding è¡¨å¹¶æ²¡æœ‰åœ¨åŠ è½½è¿‡ç¨‹ä¸­ç›´æ¥ç¡®å®šåœ°å€åˆ—è¡¨ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°çš„æ—¶å€™ï¼Œé€šè¿‡ <strong>PLT(Procedure Linkage Table)</strong> æ¥è¿›è¡Œä¸€æ¬¡ Lazy Bindingã€‚æ¥ä½¿ç”¨ <code>printf</code> æ–¹æ³•éªŒè¯ä¸€ä¸‹ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token string">"hello desgard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ‹–åˆ° <em>Hopper</em> ä¸­æŸ¥çœ‹æ±‡ç¼–ï¼š</p>
<pre class=" language-c"><code class="language-c"> _main<span class="token punctuation">:</span>
push       rbp
mov        rbp<span class="token punctuation">,</span> rsp
sub        rsp<span class="token punctuation">,</span> <span class="token number">0x10</span>
lea        rdi<span class="token punctuation">,</span> qword <span class="token punctuation">[</span><span class="token number">0x100000f8e</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token string">"hello world\\n"</span><span class="token punctuation">,</span> argument <span class="token string">"format"</span> <span class="token keyword">for</span> method imp___stubs__printf
mov        dword <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x0</span>
mov        al<span class="token punctuation">,</span> <span class="token number">0x0</span>
call       imp___stubs__printf
lea        rdi<span class="token punctuation">,</span> qword <span class="token punctuation">[</span><span class="token number">0x100000f9b</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token string">"hello desgard\\n"</span><span class="token punctuation">,</span> argument <span class="token string">"format"</span> <span class="token keyword">for</span> method imp___stubs__printf
mov        dword <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_8<span class="token punctuation">]</span><span class="token punctuation">,</span> eax
mov        al<span class="token punctuation">,</span> <span class="token number">0x0</span>
call       imp___stubs__printf
xor        ecx<span class="token punctuation">,</span> ecx
mov        dword <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_C<span class="token punctuation">]</span><span class="token punctuation">,</span> eax
mov        eax<span class="token punctuation">,</span> ecx
add        rsp<span class="token punctuation">,</span> <span class="token number">0x10</span>
pop        rbp
ret
</code></pre>
<p>å‘ç°åœ¨ä½¿ç”¨ <code>printf</code> çš„æ—¶å€™ä¼šè§¦å‘ <code>call imp__stubs__printf</code> è¿™æ¡æŒ‡ä»¤ã€‚ç‚¹å‡»è¿›å…¥ <code>imp__stubs__printf</code> çš„å­˜å‚¨ä½ç½®æŸ¥çœ‹ï¼š</p>
<pre class=" language-c"><code class="language-c"> imp___stubs__printf<span class="token punctuation">:</span>
jmp        qword <span class="token punctuation">[</span>_printf_ptr<span class="token punctuation">]</span> <span class="token punctuation">;</span> _printf<span class="token punctuation">,</span> CODE XREF<span class="token operator">=</span>_main<span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">,</span> _main<span class="token operator">+</span><span class="token number">41</span>
<span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token punctuation">;</span> ç»§ç»­è·Ÿè¸ª<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token number">0x100001010</span>         dq         _printf  <span class="token punctuation">;</span> DATA XREF<span class="token operator">=</span>imp___stubs__printf
</code></pre>
<p>åœ¨ä¸¤ä¸ª <code>printf</code> æ–¹æ³•å‰åŠ ä¸Šæ–­ç‚¹ï¼Œä½¿ç”¨ <em>lldb</em> å¯¹å…¶è¿›è¡Œè°ƒè¯•ï¼š</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/bbc1b3779c159c8ed75837385da50b8d.jpg" alt=""></p>
<p>ä¸ºä»€ä¹ˆè¿™é‡Œè¦è§‚æµ‹ <code>0x10001010</code> è¿™ä¸ªåœ°å€ï¼Ÿå› ä¸º <code>imp___stubs__printf</code> è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘äº†å®ƒã€‚è¿™è¯´æ˜åœ¨ <code>__la_symbol_ptr</code> è¡¨ä¸­å¯¹å…¶è¿›è¡Œäº†è®°å½•ã€‚ä½¿ç”¨ <em>MachOView</em> å¯¹å…¶è¿›è¡ŒéªŒè¯ï¼š</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/c712b86deeec548b05e427e33c8d2613.jpg" alt=""></p>
<p>å‘ç°åœ¨ <code>__DATA.__la_symbol_ptr</code> ä¸­çš„è®°å½•å€¼ä¸ <em>lldb</em> ä¸­ <code>x 0x10001010</code> å‘½ä»¤è¾“å‡ºçš„è®°å½•å€¼å‡ä¸º <code>01 00 00 0f 84</code>ã€‚è¿™ä¸ªå€¼å¯¹åº”çš„åœ°å€å°±æ˜¯ <code>imp___stubs__printf</code> è¿™ä¸ªæ¡©ä½ç½®ã€‚</p>
<pre class=" language-c"><code class="language-c"><span class="token number">0x100000f84</span>         push       <span class="token number">0x0</span>
<span class="token number">0x100000f89</span>         jmp        <span class="token number">0x100000f74</span>
</code></pre>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">;</span> Section __stub_helper
<span class="token number">0x100000f74</span>         lea        r11<span class="token punctuation">,</span> qword <span class="token punctuation">[</span>dyld_stub_binder_100001000<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span>   <span class="token punctuation">;</span> CODE XREF<span class="token operator">=</span><span class="token number">0x100000f89</span>
<span class="token number">0x100000f7b</span>         push       r11
<span class="token number">0x100000f7d</span>         jmp        qword <span class="token punctuation">[</span>dyld_stub_binder_100001000<span class="token punctuation">]</span>          <span class="token punctuation">;</span> dyld_stub_binder
<span class="token number">0x100000f83</span>         db         <span class="token number">0x90</span>
<span class="token number">0x100000f84</span>         push       <span class="token number">0x0</span>
<span class="token number">0x100000f89</span>         jmp        <span class="token number">0x100000f74</span>
</code></pre>
<p>è¿™ä¸ªä½ç½®æ˜¯ä¸æ˜¯ä¼¼æ›¾ç›¸è¯†ï¼Ÿæ˜¯çš„ï¼Œåœ¨<a href="https://xiaozhuanlan.com/topic/6750382941" target="_blank" rel="noopener">Mach-O æ–‡ä»¶æ ¼å¼æ¢ç´¢</a>ä¸€æ–‡ä¸­çš„éªŒè¯è¯•éªŒï¼Œå·²ç»è¯•éªŒè¿‡äº† Stub æœºåˆ¶ã€‚è¯´é“è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ MachOView ä¸­çš„ <code>__TEXT.__stubs</code> è¿™ä¸ª Section å¯¹å…¶è¿›è¡ŒéªŒè¯ï¼š</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/b7737cdfbca42a2376451fa91ac7f4d8.jpg" alt=""></p>
<p>ä¸é¢„æƒ³ä¸­çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ªåœ¨ <code>__TEXT.__stub_helper</code> ä¸­è§£æå‡ºçš„æ±‡ç¼–ä»£ç å’Œ <em>Hopper</em> ä¸­å®Œå…¨ä¸€è‡´ã€‚åœ¨è¿™é‡Œé€šè¿‡ <code>_stub_helper</code> æ¥è°ƒç”¨ <code>dyld_stu_binder</code> æ–¹æ³•è®¡ç®— <code>printf</code> å‡½æ•°çš„çœŸå®åœ°å€ã€‚å…¶å…·ä½“ä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œ<code>jmpq 0x100000f74</code> å°±æ˜¯åœ¨ <code>pushq</code> å‚æ•° <code>$0x0</code> ï¼ˆlink è¿‡ç¨‹ä¸­çš„æ ‡è®°å€¼ï¼‰åè·³è½¬åˆ°è¿™ä¸ª section çš„å¤´éƒ¨ï¼Œå¹¶è°ƒç”¨ <code>binder</code> æ–¹æ³•ã€‚</p>
<p><code>binder</code> æ–¹æ³•çš„ä½œç”¨ç®€å•æ¥è®²å°±æ˜¯è®¡ç®—å¯¹åº”çš„å‡½æ•°åœ°å€è¿›è¡Œç»‘å®šï¼Œä¹‹åè¿›è€Œè°ƒç”¨å¯¹åº”å‡½æ•°ã€‚</p>
<p>åœ¨ç¬¬äºŒæ¬¡è¾“å‡º <code>0x10001010</code> çš„å€¼çš„æ—¶å€™ï¼Œå‘ç°ä¸ç¬¬ä¸€æ¬¡çš„å€¼ä¸ç›¸åŒäº†ã€‚å˜æˆäº† <code>7f ff 76 cc 98 c4</code>ã€‚è¿™ä¸ªåœ°å€å…¶å®å°±æ˜¯ <code>printf</code> çš„çœŸå®åœ°å€ã€‚é€šè¿‡ <code>x</code> å‘½ä»¤åŠæ–¹æ³•åçš„æ–¹å¼è¿›è¡ŒéªŒè¯ï¼š</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/5f68343de4d2645ed649f790f6f82b1d.jpg" alt=""></p>
<p>ä¹Ÿå°±æ˜¯è¯´ <code>__DATA.__la_symbol_ptr</code> ä¸­æŒ‡å‘ <code>printf</code> åœ°å€çš„å€¼å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œå¹¶çœŸæ­£çš„æŒ‡å‘äº† <code>printf</code> æŒ‡ä»¤ã€‚</p>
<h3 id="Dynamic-Symbol-Table"><a href="#Dynamic-Symbol-Table" class="headerlink" title="Dynamic Symbol Table"></a>Dynamic Symbol Table</h3><p><strong>Dynamic Symbol Table</strong> åŠ¨æ€ç¬¦å·è¡¨æ˜¯ç”¨æ¥åŠ è½½åŠ¨æ€åº“çš„æ—¶å€™å¯¼å‡ºçš„ç¬¦å·è¡¨ï¼Œè¯¥è¡¨åœ¨ dyld æ—¶æœŸä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨å¯¹è±¡è¢«åŠ è½½çš„æ—¶å€™æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´ DST æ˜¯ç¬¦å·è¡¨çš„å­é›†ã€‚å¯¹äº ELF æ¥è®²ï¼ŒDST æ˜¯æœ‰å…¶å®šä¹‰çš„ï¼›ä½†æ˜¯å¯¹äº Mach-O æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸º DST å°±æ˜¯ <strong>Symbol Stubs</strong>ã€‚DST å’Œ Mach-O ä¸­çš„ <em>Indirect Addressing</em> æœ‰å¾ˆå¤§çš„å…³è”ï¼Œè¿™é‡Œç»™å‡º Apple å¯¹äº <em>Indirect Addressing</em> çš„[å®˜æ–¹æ–‡æ¡£] (<a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/indirect_addressing.html)ã€‚" target="_blank" rel="noopener">https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/MachOTopics/1-Articles/indirect_addressing.html)ã€‚</a></p>
<p>è¿™ä¸ªæ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»‹ç»äº† <em>Non-lazy symbol references</em>ã€<em>Lazy symbol reference</em> çš„ç‰¹ç‚¹å’ŒåŒºåˆ«ã€‚å…¶ä¸­ <em>Lazy symbol reference</em> æ˜¯æŒ‡åœ¨æ–¹æ³•åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šæ ¹æ® dyld è¿‡ç¨‹æ—¶åŠ è½½çš„æ˜ å°„åœ°å€è¿›è¡Œå¤„ç†ï¼Œå®Œæˆç»‘å®šæ“ä½œã€‚</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/876d51366fc5a941dbb47ef07bb8e7e2.jpg" alt=""></p>
<p>ã€é€šè¿‡ MachOView æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ <strong>Dynamic Symbol Table</strong> ä¸­çš„æ‰€æœ‰ <em>Indirect Symbol</em>ã€‘</p>
<h2 id="ç†è§£-fishhook"><a href="#ç†è§£-fishhook" class="headerlink" title="ç†è§£ fishhook"></a>ç†è§£ fishhook</h2><h3 id="æ˜ç¡®æ€è·¯"><a href="#æ˜ç¡®æ€è·¯" class="headerlink" title="æ˜ç¡®æ€è·¯"></a>æ˜ç¡®æ€è·¯</h3><p>æ ¹æ®ä¸Šé¢çš„å®æˆ˜å†…å®¹ï¼Œæˆ‘ä»¬ç†è§£äº† Lazy Binding è¿™ä¸ªè¿‡ç¨‹ã€‚å—æ­¤å¯å‘ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥é‡æ–°ç»‘å®š Mach-O çš„ Symbol ä»è€Œ hook ä¸€äº› C ä¸­çš„åº“å‡½æ•°å‘¢ï¼Ÿè¿™ä¸ªæ€è·¯åœ¨ <a href="https://github.com/facebook/fishhook" target="_blank" rel="noopener">fishhook</a> ä¸­å·²ç»å®ç°ã€‚</p>
<h3 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h3><p>ä¸ºäº†ç®€åŒ–åˆ†æè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªä¾‹å­ï¼Œä¹‹åçš„åˆ†æéƒ½ä¼šå›´ç»•ç€è¿™ä¸ªä¾‹å­æ¥è¿›è¡Œã€‚å®ä¾‹ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ä¿®æ”¹åº“å‡½æ•° <code>strlen</code>ï¼Œè®©å…¶å§‹ç»ˆè¿”å› <code>666</code>ã€‚</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"fishhook.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>original_strlen<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>_s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">new_strlen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>_s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">666</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> rebinding strlen_rebinding <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"strlen"</span><span class="token punctuation">,</span> new_strlen<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>original_strlen <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">rebind_symbols</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebinding<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span> strlen_rebinding <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token string">"hellolazy"</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>åœ¨ <code>main</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ„é€ äº†ä¸€ä¸ª <code>rebinding</code> ç»“æ„ä½“å®ä¾‹ï¼Œä½¿ç”¨<strong>åŸæ–¹æ³•å</strong>ã€<strong>æ–°æ–¹æ³•çš„æŒ‡é’ˆ</strong>ä»¥åŠ<strong>ä¸€ä¸ªäºŒé˜¶æŒ‡é’ˆ</strong>ï¼ˆåé¢æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°è¿™é‡Œå­˜å‚¨äº† <code>__bss</code> æ®µä¸­åŸæ–¹æ³•çš„åœ°å€ï¼‰ã€‚</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> rebinding <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åŸæ–¹æ³•å</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>replacement<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ–°æ–¹æ³•çš„ä»£ç æ®µé¦–åœ°å€</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>replaced<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ—§æ–¹æ³•çš„æŒ‡é’ˆ</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>åœ¨è·Ÿè¸ªä»£ç ä¹‹å‰ï¼Œæˆ‘å…ˆä½¿ç”¨ <code>nm</code> å‘½ä»¤å¯¹ç”Ÿæˆçš„æ‰§è¡Œæ–‡ä»¶æŸ¥çœ‹ File ä¸­çš„ç¬¦å·ä¿¡æ¯ï¼ˆ <code>-n</code> å‚æ•°æ˜¯æ ¹æ®å·²çŸ¥åœ°å€è¿›è¡Œæ’åºï¼‰ï¼š</p>
<pre class=" language-c"><code class="language-c">$ nm <span class="token operator">-</span>n TestObjcProj
                 U ___memcpy_chk
                 U __dyld_get_image_header
                 U __dyld_get_image_vmaddr_slide
                 U __dyld_image_count
                 U __dyld_register_func_for_add_image
                 U _dladdr
                 U _free
                 U _malloc
                 U _printf
                 U _strcmp
                 U _strlen
                 U _strnlen
                 U dyld_stub_binder
<span class="token number">0000000100000000</span> T __mh_execute_header
<span class="token number">0000000100000690</span> t _rebind_symbols_image
00000001000006f0 t _prepend_rebindings
00000001000007d0 t _rebind_symbols_for_image
0000000100000b00 t _rebind_symbols
0000000100000bc0 t __rebind_symbols_for_image
0000000100000bf0 t _perform_rebinding_with_section
<span class="token number">0000000100000e10</span> T _new_strlen
<span class="token number">0000000100000e20</span> T _main
<span class="token number">0000000100001090</span> b __rebindings_head
<span class="token number">0000000100001098</span> b _original_strlen
</code></pre>
<p>è¿™é‡Œæ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªç¬¦å·ï¼Œä¸‰åˆ—å€¼åˆ†åˆ«ä»£è¡¨<strong>åœ°å€</strong>ï¼Œ<strong>ç¬¦å·è¯´æ˜</strong> å’Œ <strong>ç¬¦å·å</strong>ã€‚å…¶ä¸­ç¬¦å·è¯´æ˜ä¸ºä»¥ä¸‹è§„åˆ™ï¼š</p>
<ul>
<li>å°å†™ä»£è¡¨ä½œç”¨åŸŸä¸º <em>Local</em>ï¼Œå¤§å†™ä»£è¡¨ç¬¦å·æ˜¯ <em>Global(external)</em> çš„ã€‚</li>
<li><code>A</code> - ç¬¦å·å€¼æ˜¯ç»å¯¹çš„ï¼Œåœ¨é“¾æ¥è¿‡ç¨‹ä¸­ä¸å…è®¸å¯¹å…¶æ”¹å˜ï¼Œè¿™ä¸ªç¬¦å·å¸¸å¸¸å‡ºç°åœ¨<strong>ä¸­æ–­å‘é‡è¡¨</strong>ä¸­ã€‚</li>
<li><code>B</code> - ç¬¦å·å€¼å‡ºç°åœ¨å†…å­˜ <em>BSS</em> æ®µã€‚ä¾‹å¦‚åœ¨æŸä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰å…¨å±€çš„ <em>static</em> æ–¹æ³• <code>static void test</code>ï¼Œåˆ™ç¬¦å· <em>test</em> çš„ç±»å‹ä¸º <code>b</code>ï¼Œåˆ‡å­˜å‚¨äº <em>BSS</em> ä¸­ã€‚å…¶å€¼ä¸ºè¯¥ç¬¦å·åœ¨ <em>BSS</em> ä¸­çš„åç§»ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ<em>BSS</em> åˆ†é…åœ¨ RAM ä¸­ã€‚</li>
<li><code>C</code> - ç§°ä¸º<strong>Common Symbol</strong> <strong>ä¸€èˆ¬ç¬¦å·</strong>ï¼Œæ˜¯ä¸ºåˆå§‹åŒ–çš„æ•°æ®æ®µã€‚è¯¥ç¬¦å·ä¸åŒ…å«äºæ™®é€šçš„ Section ä¸­ã€‚åªæœ‰åœ¨é“¾æ¥è¿‡ç¨‹æ‰ä¼šè¿›è¡Œåˆ†é…ã€‚ç¬¦å·çš„å€¼ä¸ºæ‰€éœ€è¦çš„å­—èŠ‚æ•°ã€‚</li>
<li><code>D</code> - ç§°ä¹‹ä¸º <strong>Data Symbol</strong>ã€‚ä½äºåˆå§‹åŒ–æ•°æ®æ®µä¸­ã€‚ä¸€èˆ¬åˆ†é…åˆ° <em>Data Section</em> ä¸­ã€‚ä¾‹å¦‚å…¨å±€çš„ <code>int table[5] = {233, 123, 321, 132, 231};</code>ï¼Œä¼šåˆ†é…åˆ°åˆå§‹åŒ–æ•°æ®æ®µä¸­ã€‚</li>
<li><code>T</code> - è¯¥ç¬¦å·ä½äºä»£ç åŒº <em>TS</em> ä¸­ã€‚</li>
<li><code>U</code> - è¯´æ˜<strong>å½“å‰æ–‡ä»¶ä¸­è¯¥ç¬¦å·æ˜¯æœªå®šä¹‰çš„ï¼Œè¯¥ç¬¦å·çš„å®šä¹‰åœ¨åˆ«çš„æ–‡ä»¶ä¸­</strong>ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ‰¾åˆ°è¿™å‡ ä¸ªä¸ <code>strlen</code> å…ˆå…³çš„ç¬¦å·ï¼Œå…ˆè®°å½•ä¸‹æ¥ï¼š</p>
<pre class=" language-c"><code class="language-c">                 U _strlen    # ç³»ç»Ÿåº“æ–¹æ³•ï¼Œdyld åŠ¨æ€åŠ è½½ï¼Œæ‰€ä»¥æœªå®šä¹‰
<span class="token number">0000000100000e10</span> T _new_strlen  # è‡ªå®šä¹‰æ–¹æ³•ï¼Œä½äº Text Section
<span class="token number">0000000100001098</span> b _original_strlen  #
</code></pre>
<p>å¦å¤–æˆ‘ä»¬è¿˜éœ€è¦äº†è§£çš„ä¸€äº›åŸºåœ°å€ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š<strong>Lazy Symbol Pointer Table</strong>(<code>__DATA.__la_symbol_ptr</code>)ã€<strong>Indirect Symbol Table</strong>ã€<strong>Symbol Table</strong>ã€‚è¿™äº›å‡èƒ½ä» <em>MachOView</em> ä¸­è·å¾—åˆ°ã€‚</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/440fcefd2a587adf65cbbeb027e4d43b.jpg" alt=""></p>
<p>è·å–åˆ° <code>__DATA.__la_symbol_ptr</code> åŸºåœ°å€ä¸º <code>0x100001010</code>ã€‚</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/932f41c8d493470a857c0d67d7dadcd5.jpg" alt=""></p>
<p>è¿™é‡Œè·å–åˆ°åœ¨ <strong>Indirect Symbols</strong> ä¸­ï¼Œ<code>_strlen</code> ç¬¦å·çš„åœ°å€ä¸º <code>0x1000025f0</code>ã€‚</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/fc02421bd0b73a013f045495b49955ff.jpg" alt=""></p>
<p>è¿™é‡Œå¯ä»¥è·å–åˆ°åœ¨ <strong>Symbol Table</strong> ä¸­å¯¹åº”çš„ç¬¦å·ä½ç½® <code>0x100002560</code>ï¼Œè€Œä¸”å…¶ä¸­è¿˜èƒ½æ£€ç´¢åˆ°åœ¨ <strong>String Table</strong> ä¸­å¯¹åº”çš„ç¬¦å· <code>_strlen</code> çš„ç¬¦å·åç§°ã€‚</p>
<h3 id="è°ƒè¯•ä»£ç "><a href="#è°ƒè¯•ä»£ç " class="headerlink" title="è°ƒè¯•ä»£ç "></a>è°ƒè¯•ä»£ç </h3><p>åœ¨è¿›è¡Œ hook çš„ä»£ç é€»è¾‘ä¸­ï¼Œåœ¨å£°æ˜ä¸€ä¸ª <code>strlen_rebinding</code> å®ä¾‹ä¹‹åï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨æ–¹æ³• <code>rebind_symbols</code> ï¼Œå…¶ä¸­éœ€è¦ä¼ å…¥ä¸€ä¸ª <code>rebinding</code> æ•°ç»„çš„å¤´åœ°å€ï¼Œä»¥åŠå…¶ <em>size</em>ã€‚ä¸‹é¢æ¥çœ‹ä¸€ä¸‹ <code>rebind_symbols</code> æ–¹æ³•çš„å®ç°ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> __SIZE_TYPE__ long unsigned int</span>
<span class="token keyword">typedef</span> __SIZE_TYPE__ size_t<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/**
 * rebind_symbols
 * struct rebinding rebindings[] - rebinding ç»“æ„ä½“æ•°ç»„
 * size_t rebindings_nel - æ•°ç»„é•¿åº¦
 */</span>
<span class="token keyword">int</span> <span class="token function">rebind_symbols</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebinding rebindings<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size_t rebindings_nel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ç»´æŠ¤ä¸€ä¸ª rebindings_entry çš„ç»“æ„</span>
    <span class="token comment" spellcheck="true">// å°† rebinding çš„å¤šä¸ªå®ä¾‹ç»„ç»‡æˆä¸€ä¸ªé“¾è¡¨</span>
    <span class="token keyword">int</span> retval <span class="token operator">=</span> <span class="token function">prepend_rebindings</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_rebindings_head<span class="token punctuation">,</span> rebindings<span class="token punctuation">,</span> rebindings_nel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// åˆ¤æ–­æ˜¯å¦ malloc å¤±è´¥ï¼Œå¤±è´¥ä¼šè¿”å› -1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// _rebindings_head -> next æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ ‡å¿—ç¬¦ï¼ŒNULL åˆ™ä»£è¡¨ç¬¬ä¸€æ¬¡è°ƒç”¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_rebindings_head<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°† _rebind_symbols_for_image æ³¨å†Œä¸ºå›è°ƒ</span>
        <span class="token function">_dyld_register_func_for_add_image</span><span class="token punctuation">(</span>_rebind_symbols_for_image<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å…ˆè·å– dyld é•œåƒæ•°é‡</span>
        uint32_t c <span class="token operator">=</span> <span class="token function">_dyld_image_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®ä¸‹æ ‡ä¾æ¬¡è¿›è¡Œé‡ç»‘å®šè¿‡ç¨‹</span>
            <span class="token function">_rebind_symbols_for_image</span><span class="token punctuation">(</span><span class="token function">_dyld_get_image_header</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_dyld_get_image_vmaddr_slide</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// è¿”å›çŠ¶æ€å€¼</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸ºäº†<strong>å°†å¤šæ¬¡ç»‘å®šæ—¶çš„å¤šä¸ªç¬¦å·</strong>ç»„ç»‡æˆä¸€ä¸ªé“¾å¼ç»“æ„ï¼Œ<em>fishhook</em> è‡ªå®šä¹‰äº†ä¸€ä¸ªé“¾è¡¨ç»“æ„æ¥ç»„ç»‡è¿™ä¸ªé€»è¾‘ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> rebindings_entry <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> rebinding <span class="token operator">*</span>rebindings<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rebinding æ•°ç»„å®ä¾‹</span>
    size_t rebindings_nel<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å…ƒç´ æ•°é‡</span>
    <span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// é“¾è¡¨ç´¢å¼•</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// å…¨å±€é‡ï¼Œç›´æ¥æ‹¿å‡ºè¡¨å¤´</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span>_rebindings_head<span class="token punctuation">;</span>
</code></pre>
<p>åœ¨ <code>prepend_rebindings</code> æ–¹æ³•ä¸­ï¼Œ<em>fishhook</em> ä¼šç»´æŠ¤è¿™ä¸ªç»“æ„ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/**
 * prepend_rebindings ç”¨äº rebindings_entry ç»“æ„çš„ç»´æŠ¤
 * struct rebindings_entry **rebindings_head - å¯¹åº”çš„æ˜¯ static çš„ _rebindings_head
 * struct rebinding rebindings[] - ä¼ å…¥çš„æ–¹æ³•ç¬¦å·æ•°ç»„
 * size_t nel - æ•°ç»„å¯¹åº”çš„å…ƒç´ æ•°é‡
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">prepend_rebindings</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span><span class="token operator">*</span>rebindings_head<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> rebinding rebindings<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              size_t nel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// å£°æ˜ rebindings_entry ä¸€ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸ºå…¶åˆ†é…ç©ºé—´</span>
    <span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span>new_entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebindings_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// åˆ†é…ç©ºé—´å¤±è´¥çš„å®¹é”™å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ä¸ºé“¾è¡¨ä¸­å…ƒç´ çš„ rebindings å®ä¾‹åˆ†é…æŒ‡å®šç©ºé—´</span>
    new_entry<span class="token operator">-></span>rebindings <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> rebinding <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebinding<span class="token punctuation">)</span> <span class="token operator">*</span> nel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// åˆ†é…ç©ºé—´å¤±è´¥çš„å®¹é”™å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_entry<span class="token operator">-></span>rebindings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">free</span><span class="token punctuation">(</span>new_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// å°† rebindings æ•°ç»„ä¸­ copy åˆ° new_entry -> rebingdings æˆå‘˜ä¸­</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>new_entry<span class="token operator">-></span>rebindings<span class="token punctuation">,</span> rebindings<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebinding<span class="token punctuation">)</span> <span class="token operator">*</span> nel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ä¸º new_entry -> rebindings_nel èµ‹å€¼</span>
    new_entry<span class="token operator">-></span>rebindings_nel <span class="token operator">=</span> nel<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ä¸º new_entry -> newx èµ‹å€¼ï¼Œç»´æŠ¤é“¾è¡¨ç»“æ„</span>
    new_entry<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token operator">*</span>rebindings_head<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç§»åŠ¨ head æŒ‡é’ˆï¼ŒæŒ‡å‘è¡¨å¤´</span>
    <span class="token operator">*</span>rebindings_head <span class="token operator">=</span> new_entry<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¹‹åè¿™ä¸€éƒ¨åˆ†çš„ç»“æ„å°†ä¼šæŒç»­è¢«ç»´æŠ¤ï¼Œç”¨å›¾ç¤ºæ¥è¯´æ˜ä¸€ä¸‹ï¼š</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/7c60b27e4d462ba9d278c0ef118f049b.jpg" alt=""></p>
<p>åœ¨æ‰§è¡Œå®Œé“¾è¡¨çš„åˆå§‹åŒ–åŠç»“æ„ç»´æŠ¤çš„ <code>prepend_rebindings</code> æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œã€‚ç”±äºæˆ‘ä»¬çš„ <code>strlen</code> æ˜¯ dyld åŠ è½½çš„ç³»ç»Ÿåº“æ–¹æ³•ï¼Œæ‰€ä»¥ <code>_rebindings_head -&gt; next</code> åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ä¸ºç©ºï¼Œå› ä¸ºæ²¡æœ‰åšè¿‡æ›¿æ¢ç¬¦å·ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ <code>_dyld_register_func_for_add_image</code> æ¥æ³¨å†Œ <code>_rebind_symbols_for_image</code> æ–¹æ³•ï¼Œä¹‹åç¨‹åºæ¯æ¬¡åŠ è½½åŠ¨æ€åº“çš„æ—¶å€™ï¼Œéƒ½ä¼šå»è°ƒç”¨è¯¥æ–¹æ³•ã€‚å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ›¿æ¢ç¬¦å·ï¼Œåˆ™<strong>éå†å·²ç»åŠ è½½çš„åŠ¨æ€åº“</strong>ã€‚</p>
<p>è¿™ä¸€å—çš„æµç¨‹ä¹Ÿæ˜¯ <em>fishhook</em> ä»£ç çš„ç²¾é«“éƒ¨åˆ†ï¼Œé€ä¸€æ¥åˆ†æè¿™äº›åœ°æ–¹ã€‚</p>
<h4 id="dyld-register-func-for-add-image-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#dyld-register-func-for-add-image-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="_dyld_register_func_for_add_image æ˜¯ä»€ä¹ˆï¼Ÿ"></a><code>_dyld_register_func_for_add_image</code> æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>è¿™é‡Œç¬”è€…æŸ¥çœ‹äº† Apple å®˜æ–¹çš„ <code>dyld.h</code> å¤´æ–‡ä»¶ï¼Œå…¶ä¸­å¯¹äº <code>_dyld_register_func_for_add_image</code> æœ‰è¾ƒä¸ºè¯¦ç»†çš„è¯´æ˜ï¼ˆ<a href="https://opensource.apple.com/source/dyld/dyld-433.5/include/mach-o/dyld.h.auto.html" target="_blank" rel="noopener">dyld.h</a>ï¼‰ï¼š</p>
<blockquote>
<p>The following functions allow you to install callbacks which will be called by dyld whenever an image is loaded or unloaded.  During a call to _dyld_register_func_for_add_image() the callback func is called for every existing image.  Later, it is called as each new image is loaded and bound (but initializers not yet run).  The callback registered with _dyld_register_func_for_remove_image() is called after any terminators in an image are run and before the image is un-memory-mapped.</p>
</blockquote>
<p><code>_dyld_register_func_for_add_image</code> è¿™ä¸ªæ–¹æ³•å½“é•œåƒ <em>Image</em> è¢« <em>load</em> æˆ–æ˜¯ <em>unload</em> çš„æ—¶å€™éƒ½ä¼šç”± dyld ä¸»åŠ¨è°ƒç”¨ã€‚å½“è¯¥æ–¹æ³•è¢«è§¦å‘æ—¶ï¼Œä¼šä¸ºæ¯ä¸ªé•œåƒè§¦å‘å…¶å›è°ƒæ–¹æ³•ã€‚ä¹‹ååˆ™å°†å…¶é•œåƒä¸å…¶å›ç”µå‡½æ•°è¿›è¡Œç»‘å®šï¼ˆä½†æ˜¯æœªè¿›è¡Œåˆå§‹åŒ–ï¼‰ã€‚ä½¿ç”¨ <code>_dyld_register_func_for_add_image</code> æ³¨å†Œçš„å›è°ƒå°†åœ¨é•œåƒä¸­çš„ terminators å¯åŠ¨åè¢«è°ƒç”¨ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆä¼ å…¥çš„-rebind-symbols-for-image-ä½œä¸ºå›è°ƒå‡½æ•°å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼ å…¥çš„-rebind-symbols-for-image-ä½œä¸ºå›è°ƒå‡½æ•°å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼ å…¥çš„ _rebind_symbols_for_image ä½œä¸ºå›è°ƒå‡½æ•°å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼ å…¥çš„ <code>_rebind_symbols_for_image</code> ä½œä¸ºå›è°ƒå‡½æ•°å‘¢ï¼Ÿ</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">_dyld_register_func_for_add_image</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> mach_header<span class="token operator">*</span> mh<span class="token punctuation">,</span> intptr_t vmaddr_slide<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">__OSX_AVAILABLE_STARTING</span><span class="token punctuation">(</span>__MAC_10_1<span class="token punctuation">,</span> __IPHONE_2_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">_dyld_register_func_for_remove_image</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> mach_header<span class="token operator">*</span> mh<span class="token punctuation">,</span> intptr_t vmaddr_slide<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">__OSX_AVAILABLE_STARTING</span><span class="token punctuation">(</span>__MAC_10_1<span class="token punctuation">,</span> __IPHONE_2_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>extern</code> å…³é”®å­—æ¥å‘ŠçŸ¥ç¼–è¯‘å™¨<strong>å½“è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œè¯·åœ¨å…¶ä»–æ¨¡å—ä¸­å¯»æ‰¾è¯¥æ–¹æ³•å®šä¹‰</strong>ã€‚å¹¶ä¸”åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„å£°æ˜ä¸­ï¼Œæ‰€æ³¨å†Œæ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸€å®šæ˜¯ <code>(const struct mach_header* mh, intptr_t vmaddr_slide)</code>ã€‚</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/**
 * _rebind_symbols_for_image æ˜¯ rebind_symbols_for_image çš„ä¸€ä¸ªå…¥å£æ–¹æ³•
 * è¿™ä¸ªå…¥å£æ–¹æ³•å­˜åœ¨çš„æ„ä¹‰æ˜¯æ»¡è¶³ _dyld_register_func_for_add_image ä¼ å…¥å›è°ƒæ–¹æ³•çš„æ ¼å¼
 * header - Mach-O å¤´
 * slide - intptr_t æŒæœ‰æŒ‡é’ˆ
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">_rebind_symbols_for_image</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> mach_header <span class="token operator">*</span>header<span class="token punctuation">,</span>
                                      intptr_t slide<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// å¤–å±‚æ˜¯ä¸€ä¸ªå…¥å£å‡½æ•°ï¼Œæ„åœ¨è°ƒç”¨æœ‰æ•ˆçš„æ–¹æ³• rebind_symbols_for_image</span>
    <span class="token function">rebind_symbols_for_image</span><span class="token punctuation">(</span>_rebindings_head<span class="token punctuation">,</span> header<span class="token punctuation">,</span> slide<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>çœ‹åˆ° <code>_rebind_symbols_for_image</code> æ˜¯ä¸ªå…¥å£ï¼Œæˆ‘ä»¬çš„é—®é¢˜ä¹Ÿå°±è¿åˆƒè€Œè§£äº†ã€‚æ·»åŠ è¿™ä¸ªå…¥å£æ–¹æ³•å…¶å®æ˜¯ä¸ºäº†é€‚åº”å›è°ƒå‡½æ•°çš„å‚æ•°æ ¼å¼ï¼Œä½†æ˜¯çœŸæ­£è°ƒç”¨çš„ <code>rebind_symbols_for_image</code> æ‰€éœ€è¦çš„å‚æ•°ä¸æ»¡è¶³å…¶æ–¹æ³•çš„æè¿°ã€‚</p>
<h4 id="intptr-t-æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ"><a href="#intptr-t-æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ" class="headerlink" title="intptr_t æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ"></a><code>intptr_t</code> æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</h4><p>è‡³äº <code>intptr_t</code>ï¼Œç¬”è€…åœ¨ä¹‹å‰é˜…è¯» <a href="https://book.douban.com/subject/25827246/" target="_blank" rel="noopener"><em>Understanding and using C pointers</em></a> æ—¶è§è¿‡ã€‚ä¸‹é¢ä¸ºå¼•ç”¨ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/// /usr/include/stdint.h</span>

<span class="token comment" spellcheck="true">/* Types for `void *' pointers. */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> __WORDSIZE == 64</span>
<span class="token macro property"># <span class="token directive keyword">ifndef</span> __intptr_t_defined</span>
<span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">int</span> intptr_t<span class="token punctuation">;</span>
<span class="token macro property"># <span class="token directive keyword">define</span> __intptr_t_defined</span>
<span class="token macro property"># <span class="token directive keyword">endif</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">int</span> uintptr_t<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property"># <span class="token directive keyword">ifndef</span> __intptr_t_defined</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> intptr_t<span class="token punctuation">;</span>
<span class="token macro property"># <span class="token directive keyword">define</span> __intptr_t_defined</span>
<span class="token macro property"># <span class="token directive keyword">endif</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> uintptr_t<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<blockquote>
<p><code>intptr_t</code> å’Œ <code>uintptr_t</code> è¿™ä¸¤ç§ç±»å‹ç”¨äºå­˜å‚¨æŒ‡é’ˆåœ°å€ã€‚ä»å­—é¢ä¸Šçœ‹ï¼Œ<code>intptr_t</code> åƒæ˜¯ä¸€ä¸ªæ•´å‹æŒ‡é’ˆç±»å‹ï¼Œè€Œä¸”åœ¨ <code>stdint.h</code> çš„æ³¨é‡Šä¸­ä¹Ÿå¯ä»¥çœ‹åˆ° <em>Types for void </em>pointers<em> çš„æè¿°ï¼Œä½†æˆ‘ä»¬çœ‹åˆ°å®é™…ä¸Š <code>intptr_t</code> å°±æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œåœ¨ 64 ä½å¹³å°ä¸­å®šä¹‰ä¸º <code>long int</code>ï¼Œå¦åˆ™å®šä¹‰ä¸º <code>int</code>ã€‚æˆ‘ä»¬çŸ¥é“ C è¯­è¨€çš„æŒ‡é’ˆå®é™…ä¸Šå°±æ˜¯å˜é‡çš„åœ°å€ï¼Œåœ¨ 64 ä½å¹³å°ä¸ŠæŒ‡é’ˆä¸º 8 å­—èŠ‚ï¼Œåœ¨ 32 ä½å¹³å°ä¸ŠæŒ‡é’ˆä¸º 4 å­—èŠ‚ï¼Œè€Œ <code>intptr_t</code> åˆšå¥½æ˜¯å’Œè¿™ä¸ªå­—èŠ‚æ•°å¯¹åº”ï¼Œä½¿ç”¨å®ƒå¯ä»¥å®‰å…¨åœ°è¿›è¡Œæ•´æ•°ä¸æŒ‡é’ˆçš„è½¬æ¢è¿ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦å°†æŒ‡é’ˆä½œä¸ºæ•´æ•°è¿ç®—æ—¶ï¼Œå°†å®ƒè½¬æ¢æˆ <code>intptr_t</code> è¿›è¡Œè¿ç®—æ‰æ˜¯å®‰å…¨çš„ã€‚<em>*ä½¿ç”¨ <code>int</code> æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>intptr_t</code> æ¥ä¿è¯å¹³å°çš„é€šç”¨æ€§ï¼Œå®ƒåœ¨ä¸åŒçš„å¹³å°ä¸Šç¼–è¯‘æ—¶é•¿åº¦ä¸åŒï¼Œä½†éƒ½æ˜¯æ ‡å‡†çš„å¹³å°å­—é•¿</em></em>ã€‚</p>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†å­—é•¿çš„å­˜å‚¨é‡ï¼Œç”¨æ¥ä»£è¡¨æ–¹æ³•åœ°å€çš„åç§»é‡ã€‚</p>
<h3 id="é‡ç»‘å®šå¯»å€-åŸºå€å‡†å¤‡è¿‡ç¨‹"><a href="#é‡ç»‘å®šå¯»å€-åŸºå€å‡†å¤‡è¿‡ç¨‹" class="headerlink" title="é‡ç»‘å®šå¯»å€ - åŸºå€å‡†å¤‡è¿‡ç¨‹"></a>é‡ç»‘å®šå¯»å€ - åŸºå€å‡†å¤‡è¿‡ç¨‹</h3><p><code>rebind_symbols_for_image</code> æ–¹æ³•æè¿°çš„ä¹Ÿå°±æ˜¯æ•´ä¸ª <em>fishhook</em> ç²¾åæ‰€åœ¨ - <strong>é‡ç»‘å®šç¬¦å·è¿‡ç¨‹</strong>ã€‚ç»§ç»­è·Ÿè¸ªä»£ç æ¥ç†è§£æ¯ä¸€è¡Œçš„æ„å›¾ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rebind_symbols_for_image</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span>rebindings<span class="token punctuation">,</span>
                                     <span class="token keyword">const</span> <span class="token keyword">struct</span> mach_header <span class="token operator">*</span>header<span class="token punctuation">,</span>
                                     intptr_t slide<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Dl_info info<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dladdr</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// å£°æ˜å‡ ä¸ªæŸ¥æ‰¾é‡:</span>
    <span class="token comment" spellcheck="true">// linkedit_segment, symtab_command, dysymtab_command</span>
    segment_command_t <span class="token operator">*</span>cur_seg_cmd<span class="token punctuation">;</span>
    segment_command_t <span class="token operator">*</span>linkedit_segment <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> symtab_command<span class="token operator">*</span> symtab_cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dysymtab_command<span class="token operator">*</span> dysymtab_cmd <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æ¸¸æ ‡</span>
    <span class="token comment" spellcheck="true">// header = 0x100000000 - äºŒè¿›åˆ¶æ–‡ä»¶åŸºå€é»˜è®¤åç§»</span>
    <span class="token comment" spellcheck="true">// sizeof(mach_header_t) = 0x20 - Mach-O Header éƒ¨åˆ†</span>
    <span class="token comment" spellcheck="true">// é¦–å…ˆéœ€è¦è·³è¿‡ Mach-O Header</span>
    uintptr_t cur <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>header <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mach_header_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// éå†æ¯ä¸€ä¸ª Load Commandï¼Œæ¸¸æ ‡æ¯ä¸€æ¬¡åç§»æ¯ä¸ªå‘½ä»¤çš„ Command Size å¤§å°</span>
    <span class="token comment" spellcheck="true">// header -> ncmds: Load Command åŠ è½½å‘½ä»¤æ•°é‡</span>
    <span class="token comment" spellcheck="true">// cur_seg_cmd -> cmdsize: Load å¤§å°</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> header<span class="token operator">-></span>ncmds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> cur <span class="token operator">+</span><span class="token operator">=</span> cur_seg_cmd<span class="token operator">-></span>cmdsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å–å‡ºå½“å‰çš„ Load Command</span>
        cur_seg_cmd <span class="token operator">=</span> <span class="token punctuation">(</span>segment_command_t <span class="token operator">*</span><span class="token punctuation">)</span>cur<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Load Command çš„ç±»å‹æ˜¯ LC_SEGMENT</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_SEGMENT_ARCH_DEPENDENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¯”å¯¹ä¸€ä¸‹ Load Command çš„ name æ˜¯å¦ä¸º __LINKEDIT</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>segname<span class="token punctuation">,</span> SEG_LINKEDIT<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ£€ç´¢åˆ° __LINKEDIT</span>
                linkedit_segment <span class="token operator">=</span> cur_seg_cmd<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ¤æ–­å½“å‰ Load Command æ˜¯å¦æ˜¯ LC_SYMTAB ç±»å‹</span>
        <span class="token comment" spellcheck="true">// LC_SEGMENT - ä»£è¡¨å½“å‰åŒºåŸŸé“¾æ¥å™¨ä¿¡æ¯</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_SYMTAB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ£€ç´¢åˆ° LC_SYMTAB</span>
            symtab_cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> symtab_command<span class="token operator">*</span><span class="token punctuation">)</span>cur_seg_cmd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ¤æ–­å½“å‰ Load Command æ˜¯å¦æ˜¯ LC_DYSYMTAB ç±»å‹</span>
        <span class="token comment" spellcheck="true">// LC_DYSYMTAB - ä»£è¡¨åŠ¨æ€é“¾æ¥å™¨ä¿¡æ¯åŒºåŸŸ</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_DYSYMTAB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ£€ç´¢åˆ° LC_DYSYMTAB</span>
            dysymtab_cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> dysymtab_command<span class="token operator">*</span><span class="token punctuation">)</span>cur_seg_cmd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// å®¹é”™å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>symtab_cmd <span class="token operator">||</span> <span class="token operator">!</span>dysymtab_cmd <span class="token operator">||</span> <span class="token operator">!</span>linkedit_segment <span class="token operator">||</span>
        <span class="token operator">!</span>dysymtab_cmd<span class="token operator">-></span>nindirectsyms<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// slide: ASLR åç§»é‡</span>
    <span class="token comment" spellcheck="true">// vmaddr: SEG_LINKEDIT çš„è™šæ‹Ÿåœ°å€</span>
    <span class="token comment" spellcheck="true">// fileoff: SEG_LINKEDIT åœ°å€åç§»</span>
    <span class="token comment" spellcheck="true">// å¼â‘ ï¼šbase = SEG_LINKEDITçœŸå®åœ°å€ - SEG_LINKEDITåœ°å€åç§»</span>
    <span class="token comment" spellcheck="true">// å¼â‘¡ï¼šSEG_LINKEDITçœŸå®åœ°å€ = SEG_LINKEDITè™šæ‹Ÿåœ°å€ + ASLRåç§»é‡</span>
    <span class="token comment" spellcheck="true">// å°†â‘¡ä»£å…¥â‘ ï¼šBase = SEG_LINKEDITè™šæ‹Ÿåœ°å€ + ASLRåç§»é‡ - SEG_LINKEDITåœ°å€åç§»</span>
    uintptr_t linkedit_base <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>slide <span class="token operator">+</span> linkedit_segment<span class="token operator">-></span>vmaddr <span class="token operator">-</span> linkedit_segment<span class="token operator">-></span>fileoff<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// é€šè¿‡ base + symtab çš„åç§»é‡ è®¡ç®— symtab è¡¨çš„é¦–åœ°å€ï¼Œå¹¶è·å– nlist_t ç»“æ„ä½“å®ä¾‹</span>
    nlist_t <span class="token operator">*</span>symtab <span class="token operator">=</span> <span class="token punctuation">(</span>nlist_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>linkedit_base <span class="token operator">+</span> symtab_cmd<span class="token operator">-></span>symoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// é€šè¿‡ base + stroff å­—ç¬¦è¡¨åç§»é‡è®¡ç®—å­—ç¬¦è¡¨ä¸­çš„é¦–åœ°å€ï¼Œè·å–å­—ç¬¦ä¸²è¡¨</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>strtab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>linkedit_base <span class="token operator">+</span> symtab_cmd<span class="token operator">-></span>stroff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// é€šè¿‡ base + indirectsymoff åç§»é‡æ¥è®¡ç®—åŠ¨æ€ç¬¦å·è¡¨çš„é¦–åœ°å€</span>
    uint32_t <span class="token operator">*</span>indirect_symtab <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>linkedit_base <span class="token operator">+</span> dysymtab_cmd<span class="token operator">-></span>indirectsymoff<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// å½’é›¶æ¸¸æ ‡ï¼Œå¤ç”¨</span>
    cur <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>header <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mach_header_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å†æ¬¡éå† Load Commands</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> header<span class="token operator">-></span>ncmds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> cur <span class="token operator">+</span><span class="token operator">=</span> cur_seg_cmd<span class="token operator">-></span>cmdsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cur_seg_cmd <span class="token operator">=</span> <span class="token punctuation">(</span>segment_command_t <span class="token operator">*</span><span class="token punctuation">)</span>cur<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Load Command çš„ç±»å‹æ˜¯ LC_SEGMENT</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>cmd <span class="token operator">==</span> LC_SEGMENT_ARCH_DEPENDENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æŸ¥è¯¢ Segment Name è¿‡æ»¤å‡º __DATA æˆ–è€… __DATA_CONST</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>segname<span class="token punctuation">,</span> SEG_DATA<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">strcmp</span><span class="token punctuation">(</span>cur_seg_cmd<span class="token operator">-></span>segname<span class="token punctuation">,</span> SEG_DATA_CONST<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éå† Segment ä¸­çš„ Section</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>uint j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cur_seg_cmd<span class="token operator">-></span>nsects<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å–å‡º Section</span>
                section_t <span class="token operator">*</span>sect <span class="token operator">=</span> <span class="token punctuation">(</span>section_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>cur <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>segment_command_t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> j<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// flags &amp; SECTION_TYPE é€šè¿‡ SECTION_TYPE æ©ç è·å– flags è®°å½•ç±»å‹çš„ 8 bit</span>
                <span class="token comment" spellcheck="true">// å¦‚æœ section çš„ç±»å‹ä¸º S_LAZY_SYMBOL_POINTERS</span>
                <span class="token comment" spellcheck="true">// è¿™ä¸ªç±»å‹ä»£è¡¨ lazy symbol æŒ‡é’ˆ Section</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sect<span class="token operator">-></span>flags <span class="token operator">&amp;</span> SECTION_TYPE<span class="token punctuation">)</span> <span class="token operator">==</span> S_LAZY_SYMBOL_POINTERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿›è¡Œ rebinding é‡å†™æ“ä½œ</span>
                    <span class="token function">perform_rebinding_with_section</span><span class="token punctuation">(</span>rebindings<span class="token punctuation">,</span> sect<span class="token punctuation">,</span> slide<span class="token punctuation">,</span> symtab<span class="token punctuation">,</span> strtab<span class="token punctuation">,</span> indirect_symtab<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿™ä¸ªç±»å‹ä»£è¡¨ non-lazy symbol æŒ‡é’ˆ Section</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sect<span class="token operator">-></span>flags <span class="token operator">&amp;</span> SECTION_TYPE<span class="token punctuation">)</span> <span class="token operator">==</span> S_NON_LAZY_SYMBOL_POINTERS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">perform_rebinding_with_section</span><span class="token punctuation">(</span>rebindings<span class="token punctuation">,</span> sect<span class="token punctuation">,</span> slide<span class="token punctuation">,</span> symtab<span class="token punctuation">,</span> strtab<span class="token punctuation">,</span> indirect_symtab<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>rebind_symbols_for_image</code> æ–¹æ³•å±•ç¤ºäº†å†²ç»‘å®šè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰è®¡ç®—åœ°å€çš„æµç¨‹ã€‚æµè§ˆè¿‡ä»£ç ä¹‹åæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š<strong>ä¸ºäº†å®Œæˆé‡ç»‘å®šçš„æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦è·å–å“ªäº›åœ°å€ä¿¡æ¯å‘¢ï¼Ÿ</strong></p>
<h4 id="1-è·å–-Linkedit-Base-Addr"><a href="#1-è·å–-Linkedit-Base-Addr" class="headerlink" title="1. è·å– Linkedit Base Addr"></a>1. è·å– Linkedit Base Addr</h4><p><em>fishhook</em> ç»å¤§å¤šæ•°é‡è¦çš„åœ°å€è®¡ç®—éƒ½è¦ä½¿ç”¨åˆ°æˆ–æ˜¯é—´æ¥ä½¿ç”¨åˆ° <strong>Linkedit Base Addr</strong>ã€‚è¦å¦‚ä½•ç†è§£è¿™ä¸ªåŸºåœ°å€å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆï¼š <strong>Linkedit Segment åœ¨æ–‡ä»¶ä¸­çš„é¦–åœ°å€</strong>ã€‚</p>
<p>ä¸ºä»€ä¹ˆ <em>Linkedit Segment</em> é¦–åœ°å€ä¿¡æ¯ååˆ†é‡è¦ï¼Œå› ä¸ºåœ¨ <em>Load Command</em> ä¸­ï¼Œ<code>LC_SYMTAB</code> å’Œ <code>LC_DYSYMTAB</code> çš„ä¸­æ‰€è®°å½•çš„ Offset éƒ½æ˜¯åŸºäº <strong>__LINKEDIT</strong> æ®µçš„ã€‚è€Œ <code>LC_SYMTAB</code> ä¸­é€šè¿‡åç§»é‡å¯ä»¥æ‹¿åˆ°<strong>symtab ç¬¦å·è¡¨é¦–åœ°å€</strong>ã€<strong>strtab ç¬¦å·åç§°å­—ç¬¦è¡¨é¦–åœ°å€</strong>ä»¥åŠ<strong>indirect_symtab è·³è½¬è¡¨é¦–åœ°å€</strong>ã€‚</p>
<p>æˆ‘ä»¬æ‹¿åˆ° <strong>Indirect Symbols</strong> çš„é¦–åœ°å€ <code>indirect_symtab</code> å†åŠ ä¸Š <code>LC_SEGMENT.__DATA</code> ä¸­ä»»ä½•ä¸€ä¸ª <em>Section</em> ä¿¡æ¯çš„ <code>reverved1</code> å­—æ®µå°±å¯ä»¥è·å–åˆ°å¯¹åº”çš„ <em>Indirect Address</em> ä¿¡æ¯ã€‚åœ¨è¿™ä¹‹åæˆ‘ä»¬å¯ä»¥éå†æ¯ä¸€ä¸ª <strong>Indirect Symbols</strong>ï¼Œå¹¶ä»¥ç´¢å¼•æ–¹å¼è·å–åˆ°æ¯ä¸€ä¸ª <code>nlist</code> ç»“æ„çš„ç¬¦å·ï¼Œä»ç¬¦å·ä¸­è·å–åˆ°ç¬¦å·åå­—ç¬¦ä¸²åœ¨å­—ç¬¦è¡¨ä¸­çš„åç§»é‡ï¼Œè¿›è€Œç»§ç»­è·å–ç¬¦å·åã€‚</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/29c1401c9017d1672f0cf08a05c95112.jpg" alt=""></p>
<h4 id="2-äºŒæ¬¡éå†-Load-Command-çš„ç›®çš„"><a href="#2-äºŒæ¬¡éå†-Load-Command-çš„ç›®çš„" class="headerlink" title="2. äºŒæ¬¡éå† Load Command çš„ç›®çš„"></a>2. äºŒæ¬¡éå† Load Command çš„ç›®çš„</h4><p>ç¬¬ä¸€æ¬¡éå†çš„ç›®çš„åœ¨ç¬¬ä¸€ä¸ªç–‘é—®ä¸­å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œéå†ç›®çš„æœ‰ä¸‰ä¸ªï¼Œä¸ºäº†æ‰¾å‡º <code>LC_SEGMENT(__LINKEDIT)</code>ã€<code>LC_SYMTAB</code> å’Œ <code>LC_DYSYMTAB</code> ä¸‰ä¸ª <strong>Load Command</strong>ï¼Œä»è€Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡º <em>Base Address</em>ã€<em>Symbol Table</em>ã€<em>Dynamic Symbol</em> å’Œ <em>String Table</em> çš„ä½ç½®ã€‚</p>
<p>è€Œåœ¨ç¬¬äºŒæ¬¡éå†ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è·å–çš„æ˜¯ <code>LC_SEGMENT(__DATA)</code> ä¸­ <code>__nl_symbol_ptr</code> å’Œ <code>__la_symbol_ptr</code> è¿™ä¸¤ä¸ª <em>Section</em>ã€‚å…¶ç›®çš„æ˜¯ä¸ºäº†ç¡®å®š <strong>lazy bindingæŒ‡é’ˆè¡¨</strong> å’Œ <strong>non lazy bindingæŒ‡é’ˆè¡¨</strong> åœ¨ <em>Dynamic Symbol</em> ä¸­å¯¹åº”çš„ä½ç½®ï¼Œæ–¹æ³•å°±æ˜¯è·å–åˆ° <em>reserved1</em> å­—æ®µã€‚è¿™ä¸ªåœ¨åé¢æˆ‘ä»¬ä¼šåšä¸€ä¸ªéªŒè¯å®ç°ã€‚</p>
<h3 id="é‡ç»‘å®š"><a href="#é‡ç»‘å®š" class="headerlink" title="é‡ç»‘å®š"></a>é‡ç»‘å®š</h3><p>åœ¨ä¸€åˆ‡åŸºå€å‡†å¤‡å¥½ä¹‹åï¼Œå¼€å§‹è¿›è¡Œé‡ç»‘å®š <code>perform_rebinding_with_section</code> æ–¹æ³•ï¼š</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">perform_rebinding_with_section</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span>rebindings<span class="token punctuation">,</span>
                                           section_t <span class="token operator">*</span>section<span class="token punctuation">,</span>
                                           intptr_t slide<span class="token punctuation">,</span>
                                           nlist_t <span class="token operator">*</span>symtab<span class="token punctuation">,</span>
                                           <span class="token keyword">char</span> <span class="token operator">*</span>strtab<span class="token punctuation">,</span>
                                           uint32_t <span class="token operator">*</span>indirect_symtab<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// åœ¨ Indirect Symbol è¡¨ä¸­æ£€ç´¢åˆ°å¯¹åº”ä½ç½®</span>
    uint32_t <span class="token operator">*</span>indirect_symbol_indices <span class="token operator">=</span> indirect_symtab <span class="token operator">+</span> section<span class="token operator">-></span>reserved1<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// è·å– _DATA.__nl_symbol_ptr(æˆ–__la_symbol_ptr) Section</span>
    <span class="token comment" spellcheck="true">// å·²çŸ¥å…¶ value æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œæ•´æ®µåŒºåŸŸç”¨äºŒé˜¶æŒ‡é’ˆæ¥è·å–</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>indirect_symbol_bindings <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>slide <span class="token operator">+</span> section<span class="token operator">-></span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ç”¨ size / ä¸€é˜¶æŒ‡é’ˆæ¥è®¡ç®—ä¸ªæ•°ï¼Œéå†æ•´ä¸ª Section</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> section<span class="token operator">-></span>size <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡ä¸‹æ ‡æ¥è·å–æ¯ä¸€ä¸ª Indirect Address çš„ Value</span>
        <span class="token comment" spellcheck="true">// è¿™ä¸ª Value ä¹Ÿæ˜¯å¤–å±‚å¯»å€æ—¶éœ€è¦çš„ä¸‹æ ‡</span>
        uint32_t symtab_index <span class="token operator">=</span> indirect_symbol_indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>symtab_index <span class="token operator">==</span> INDIRECT_SYMBOL_ABS <span class="token operator">||</span> symtab_index <span class="token operator">==</span> INDIRECT_SYMBOL_LOCAL <span class="token operator">||</span>
            symtab_index <span class="token operator">==</span> <span class="token punctuation">(</span>INDIRECT_SYMBOL_LOCAL   <span class="token operator">|</span> INDIRECT_SYMBOL_ABS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·å–ç¬¦å·ååœ¨å­—ç¬¦è¡¨ä¸­çš„åç§»åœ°å€</span>
        uint32_t strtab_offset <span class="token operator">=</span> symtab<span class="token punctuation">[</span>symtab_index<span class="token punctuation">]</span><span class="token punctuation">.</span>n_un<span class="token punctuation">.</span>n_strx<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–ç¬¦å·å</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>symbol_name <span class="token operator">=</span> strtab <span class="token operator">+</span> strtab_offset<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿‡æ»¤æ‰ç¬¦å·åå°äº 4 ä½çš„ç¬¦å·</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strnlen</span><span class="token punctuation">(</span>symbol_name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å–å‡º rebindings ç»“æ„ä½“å®ä¾‹æ•°ç»„ï¼Œå¼€å§‹éå†é“¾è¡¨</span>
        <span class="token keyword">struct</span> rebindings_entry <span class="token operator">*</span>cur <span class="token operator">=</span> rebindings<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯¹äºé“¾è¡¨ä¸­æ¯ä¸€ä¸ª rebindings æ•°ç»„çš„æ¯ä¸€ä¸ª rebinding å®ä¾‹</span>
            <span class="token comment" spellcheck="true">// ä¾æ¬¡åœ¨ String Table åŒ¹é…ç¬¦å·å</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>uint j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cur<span class="token operator">-></span>rebindings_nel<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç¬¦å·åä¸æ–¹æ³•ååŒ¹é…</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>symbol_name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯¹è·³è½¬åœ°å€è¿›è¡Œé‡å†™</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replaced <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>
                        indirect_symbol_bindings<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replacement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è®°å½•åŸå§‹è·³è½¬åœ°å€</span>
                        <span class="token operator">*</span><span class="token punctuation">(</span>cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replaced<span class="token punctuation">)</span> <span class="token operator">=</span> indirect_symbol_bindings<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// é‡å†™è·³è½¬åœ°å€</span>
                    indirect_symbol_bindings<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token operator">-></span>rebindings<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>replacement<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å®Œæˆåä¸å†å¯¹å½“å‰ Indirect Symbol å¤„ç†</span>
                    <span class="token comment" spellcheck="true">// ç»§ç»­è¿­ä»£åˆ°ä¸‹ä¸€ä¸ª Indirect Symbol</span>
                    <span class="token keyword">goto</span> symbol_loop<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é“¾è¡¨éå†</span>
            cur <span class="token operator">=</span> cur<span class="token operator">-></span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    symbol_loop<span class="token punctuation">:</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è¿™æ®µæ–¹æ³•ä¸»è¦æè¿°äº†æ›¿æ¢ <code>__DATA.__la_symbol_ptr</code> å’Œ <code>__DATA.__la_symbol_ptr</code> çš„ <em>Indirect Pointer</em> ä¸»è¦è¿‡ç¨‹ã€‚ä» <code>reserved1</code> å­—æ®µè·å–åˆ° <em>Indirect Symbols</em> å¯¹åº”çš„ä½ç½®ã€‚ä»ä¸­æˆ‘ä»¬å¯ä»¥è·å–åˆ°æŒ‡å®šç¬¦å·çš„åç§»é‡ï¼Œè¿™ä¸ªåç§»é‡ä¸»è¦ç”¨æ¥åœ¨ String Table ä¸­æ£€ç´¢å‡ºç¬¦å·åç§°å­—ç¬¦ä¸²ã€‚ä¹‹åæˆ‘ä»¬æ‰¾åˆ° <code>__DATA.__la_symbol_ptr</code> å’Œ <code>__DATA.__la_symbol_ptr</code> è¿™ä¸¤ä¸ª Sectionã€‚è¿™ä¸¤ä¸ªè¡¨ä¸­ï¼Œéƒ½æ˜¯ç”± <em>Indirect Pointer</em> æ„æˆçš„æŒ‡é’ˆæ•°ç»„ï¼Œä½†æ˜¯<strong>å…¶ä¸­çš„å…ƒç´ å†³å®šäº†æˆ‘ä»¬è°ƒç”¨çš„æ–¹æ³•åº”è¯¥ä»¥å“ªä¸ªä»£ç æ®µçš„æ–¹æ³•æ¥æ‰§è¡Œ</strong>ã€‚æˆ‘ä»¬éå†è¿™ä¸ªæŒ‡é’ˆæ•°ç»„ä¸­æ¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨æ¯ä¸€å±‚éå†ä¸­å–å‡ºå…¶ç¬¦å·åç§°ï¼Œä¸æˆ‘ä»¬çš„ <code>rebindings</code> é“¾è¡¨ä¸­æ¯ä¸€ä¸ªå…ƒç´ è¿›è¡Œæ¯”å¯¹ï¼Œå½“åç§°åŒ¹é…çš„æ—¶å€™ï¼Œé‡å†™å…¶æŒ‡å‘åœ°å€ã€‚</p>
<p><img src="https://diycode.b0.upaiyun.com/photo/2017/fdbc9391bddb6c9989eeb4fcdbabf9ae.jpg" alt=""></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯ <em>fishhook</em> çš„å…¨éƒ¨æºç å®ç°ã€‚æœ¬æ–‡å®Œæˆäº†å¯¹äº <em>fishhook</em> å…¨éƒ¨è¿è¡Œæ—¶æµç¨‹è¿›è¡Œäº†è¯¦å°½çš„åˆ†æã€‚åœ¨ <a href="">éªŒè¯è¯•éªŒ - æ¢æ±‚ fishhook åŸç†ï¼ˆäºŒï¼‰</a> ä¸­ï¼Œå°†ä¼šå¯¹ <em>fishhook</em> çš„å…¨éƒ¨æµç¨‹ä»¥è®¡ç®—çš„æ–¹å¼è¿›è¡Œæ¨¡æ‹Ÿå®è·µã€‚å¹¶å¯¹ <em>fishhook</em> ä»£ç ä¸­çš„ä¸€äº›å¤„ç†å’ŒæŠ€å·§åšå‡ºä¸€ä¸€å‰–æã€‚å°½è¯·æœŸå¾…ã€‚</p>
<h2 id="å¼•æ–‡"><a href="#å¼•æ–‡" class="headerlink" title="å¼•æ–‡"></a>å¼•æ–‡</h2><ul>
<li><a href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener">Linux Tools Quick Tutorial</a></li>
<li><a href="https://amywushu.github.io/2017/02/27/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-Hook-%E5%8E%9F%E7%90%86%E4%B9%8B-fishhook-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html" target="_blank" rel="noopener">Hook åŸç†ä¹‹ fishhook æºç è§£æ</a></li>
</ul>
<h2 id="é¸£è°¢"><a href="#é¸£è°¢" class="headerlink" title="é¸£è°¢"></a>é¸£è°¢</h2><p>æ„Ÿè°¢ <a href="http://www.alonemonkey.com/" target="_blank" rel="noopener">AloneMonkey</a> å’Œ <a href="http://jmpews.github.io/" target="_blank" rel="noopener">jmpews</a> ä¸¤ä½å¤§ç‰›å¯¹æˆ‘çš„ä¸€äº›å¸®åŠ©ã€‚</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/12/19/leetcode-weekly-contest-63/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            æ–°ç¯‡
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Desgard_Duan's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        gua@desgard.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto:gua@desgard.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                ä¸»é¡µ
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    å½’æ¡£
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/12/">åäºŒæœˆ 2017<span class="sidebar_archives-count">3</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                åˆ†ç±»
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Algorithm/">Algorithm<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/Source-Probe/">Source Probe<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

å¾ˆé«˜å…´æ‚¨ä½¿ç”¨å¹¶å–œæ¬¢è¯¥ä¸»é¢˜ï¼Œå¼€å‘ä¸æ˜“ ååˆ†è°¢è°¢ä¸å¸Œæœ›æ‚¨å¯ä»¥ä¿ç•™ä¸€ä¸‹ç‰ˆæƒå£°æ˜ã€‚
å¦‚æœæ‚¨ä»ç„¶æƒ³åˆ é™¤çš„è¯ èƒ½å¦åªä¿ç•™ç¬¬ä¸€é¡¹å‘¢ï¼Ÿå³ "Theme Material"
å®ƒä¸ä¼šå½±å“ç¾è§‚å¹¶å¯ä»¥ç»™å¼€å‘è€…å¾ˆå¤§çš„æ”¯æŒå’ŒåŠ¨åŠ›ã€‚ :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            ä¸»é¢˜ - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;Â©&nbsp;2016&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Guardia Â· ç“œåœ°
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        å¾ˆé«˜å…´æ‚¨ä½¿ç”¨è¯¥ä¸»é¢˜ï¼Œå¼€å‘ä¸æ˜“ï¼Œå¸Œæœ›æ‚¨å¯ä»¥ä¿ç•™ä¸€ä¸‹ç‰ˆæƒå£°æ˜ã€‚
        å®ƒä¸ä¼šå½±å“ç¾è§‚å¹¶å¯ä»¥ç»™å¼€å‘è€…å¾ˆå¤§çš„æ”¯æŒã€‚ :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('ç”±äº UC æµè§ˆå™¨ä½¿ç”¨ææ—§çš„å†…æ ¸ï¼Œè€Œæœ¬ç½‘ç«™ä½¿ç”¨äº†ä¸€äº›æ–°çš„ç‰¹æ€§ã€‚\nä¸ºäº†æ‚¨èƒ½æ›´å¥½çš„æµè§ˆï¼Œæ¨èä½¿ç”¨ Chrome æˆ– Firefox æµè§ˆå™¨ã€‚');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c Â© Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
